version: "3.9"

services:
  # ==========================
  # MySQL chung cho toàn hệ thống
  # ==========================
  mysql:
    image: mysql:8.0
    container_name: todo-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword        # đổi cho mạnh hơn
      MYSQL_DATABASE: todo_auth               # DB khởi tạo ban đầu, các schema khác tạo bằng todoapp.sql
      MYSQL_USER: todo_user                   # optional
      MYSQL_PASSWORD: todopass                # optional
    ports:
      - "3306:3306"                           # nếu muốn connect từ ngoài để debug
    volumes:
      - mysql_data:/var/lib/mysql
      - ./todoapp.sql:/docker-entrypoint-initdb.d/todoapp.sql:ro
    networks:
      - todo-net
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    restart: unless-stopped
    env_file:
      - ./auth-service/.env
    depends_on:
      - mysql
    expose:
      - "3001"
    networks:
      - todo-net
  workspace-service:
    build:
      context: ./workspace-service
      dockerfile: Dockerfile
    container_name: workspace-service
    restart: unless-stopped
    env_file:
      - ./workspace-service/.env
    depends_on:
      - mysql
      - auth-service
    expose:
      - "3002"
    networks:
      - todo-net
  group-service:
    build:
      context: ./group-service
      dockerfile: Dockerfile
    container_name: group-service
    restart: unless-stopped
    env_file:
      - ./group-service/.env
    depends_on:
      - mysql
      - auth-service
      - workspace-service
    expose:
      - "3003"
    networks:
      - todo-net

  project-service:
    build:
      context: ./project-service
      dockerfile: Dockerfile
    container_name: project-service
    restart: unless-stopped
    env_file:
      - ./project-service/.env
    depends_on:
      - mysql
      - auth-service
      - workspace-service
      - group-service
    expose:
      - "3004"
    networks:
      - todo-net
  task-service:
    build:
      context: ./task-service
      dockerfile: Dockerfile
    container_name: task-service
    restart: unless-stopped
    env_file:
      - ./task-service/.env
    depends_on:
      - mysql
      - auth-service
      - project-service
    expose:
      - "3005"
    networks:
      - todo-net
  utility-service:
    build:
      context: ./utility-service
      dockerfile: Dockerfile
    container_name: utility-service
    restart: unless-stopped
    env_file:
      - ./utility-service/.env
    depends_on:
      - mysql
    expose:
      - "3006"
    volumes:
      - utility_uploads:/usr/src/app/uploads      
    networks:
      - todo-net
  notification-service:
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    restart: unless-stopped
    env_file:
      - ./notification-service/.env
    depends_on:
      - mysql
      - auth-service
    expose:
      - "3007"
    networks:
      - todo-net
  nginx-gateway:
    image: nginx:1.27
    container_name: nginx-gateway
    restart: unless-stopped
    depends_on:
      - auth-service
      - workspace-service
      - group-service
      - project-service
      - task-service
      - utility-service
      - notification-service
    ports:
      - "80:80"                                
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - todo-net
networks:
  todo-net:
    driver: bridge

volumes:
  mysql_data:
  utility_uploads:
